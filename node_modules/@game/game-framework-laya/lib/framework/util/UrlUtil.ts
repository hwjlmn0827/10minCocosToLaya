import Singleton from './Singleton';

/**
 * url处理类
 */
export default class UrlUtil extends Singleton {

  /**
   * 将url拼接参数后返回新的url
   * @param url 原始url
   * @param queryObject 参数Object
   */
  public getUrlAppendQueryObject(
    url: string,
    queryObject?: Record<string, any>
  ): string {
    if (queryObject == null) {
      return url;
    }
    let paramStr = '';
    Object.keys(queryObject).forEach(function(key) {
      paramStr = paramStr + key + '=' + queryObject[key] + '&';
    });
    if (paramStr == '') {
      return url;
    }
    paramStr = paramStr.substring(0, paramStr.length - 1);

    if (url.indexOf('?') == -1) {
      url = url + '?';
    } else {
      url = url + '&';
    }
    url = url + paramStr;
    return url;
  }
  
  /**
   * 将url转成imeituan格式
   * @param url 网址
   * @param query imeituan 扩展参数格式{notitlebar,wkwebview,singleton}
   */
  public getImeituanUrl(url: string, query?: {
    notitlebar?:1|0,
    wkwebview?:1,
    singleton?:number,
  }, imeituanUrlPrefix?:string) {
    if (!imeituanUrlPrefix){
      imeituanUrlPrefix = 'imeituan';
    }
    let imeituanUrl;
    if (url.startsWith('http')) {
      imeituanUrl = `${imeituanUrlPrefix}://www.meituan.com/web?url=` + encodeURIComponent(url);
      if (query) {
        if (query.notitlebar) {
          imeituanUrl = imeituanUrl + `&notitlebar=${query.notitlebar}`;
        }
        if (query.wkwebview) {
          imeituanUrl = imeituanUrl + `&wkwebview=${query.wkwebview}`;
        }
        if (query.singleton) {
          imeituanUrl = imeituanUrl + `&singleton=${query.singleton}`;
        }
      }
    }else if(url.startsWith('imeituan')){
      imeituanUrl = url.replace('imeituan', imeituanUrlPrefix);
    }else{
      imeituanUrl = url;
    }
    return imeituanUrl;
  }

  /**
   * 如果url是imeituan格式则返回原始网址
   * @param url 网址
   */
  public getUrlIfImeituan(url: string, imeituanUrlPrefix?:string) {
    if (url.startsWith('imeituan') || (imeituanUrlPrefix && url.startsWith(imeituanUrlPrefix))) {
      let urlIndex = url.indexOf('?url=');
      if(urlIndex >=0){
        let startIndex = urlIndex + 5;
        return decodeURIComponent(url.substring(startIndex));
      }
    }
    return url;
  }
}
